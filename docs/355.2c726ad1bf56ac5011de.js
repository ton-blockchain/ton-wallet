"use strict";(self.webpackChunkmytonwallet=self.webpackChunkmytonwallet||[]).push([[355],{2177:(e,t,n)=>{n.d(t,{in:()=>a}),n(1307),n(3476);var s=n(43800);function a(e){return e?(0,s.R)(e):0n}n(48287).Buffer},45232:(e,t,n)=>{n.d(t,{J5:()=>i});var s=n(31481),a=n(39989),r=n(55029),o=n(37836);const d=3e4;async function i(e,t,n){const{retries:i=s.TUC,timeouts:u=s.cSq,shouldSkipRetryFn:f=l}=n??{};let p,w="Unknown error.";for(let n=1;n<=i;n++)try{n>1&&(0,r.MD)(`Retry request #${n}:`,e.toString(),p);const s=Array.isArray(u)?u[n-1]??u[u.length-1]:Math.min(u*n,d),a=await c(e,t,s);if(p=a.status,p>=400){const{error:e}=await a.json().catch((()=>{}));throw new Error(e??`HTTP Error ${p}`)}return a}catch(e){if(w="string"==typeof e?e:e.message??w,f(w,p))throw new a.K$(w,p);n<i&&await(0,o.v7)(s.WRE*n)}throw new a.K$(w)}async function c(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:s.cSq;const a=new AbortController,r=setTimeout((()=>{a.abort()}),n);try{return await fetch(e,{...t,signal:a.signal})}finally{clearTimeout(r)}}function l(e,t){return t&&[400,404].includes(t)}},56876:(e,t,n)=>{n.r(t),n.d(t,{buildLedgerTokenTransfer:()=>Ce,checkTonApp:()=>Te,connectLedger:()=>Se,detectAvailableTransports:()=>ye,getLedgerWalletAddress:()=>Fe,getLedgerWalletInfo:()=>_e,getNextLedgerWallets:()=>qe,getTonAppInfo:()=>je,hasUsbDevice:()=>he,importLedgerWallet:()=>ve,reconnectLedger:()=>be,signLedgerProof:()=>We,signLedgerTransactions:()=>Ue,submitLedgerDnsChangeWallet:()=>Oe,submitLedgerDnsRenewal:()=>Ne,submitLedgerNftTransfer:()=>Pe,submitLedgerStake:()=>Le,submitLedgerStakingClaimOrUnlock:()=>Re,submitLedgerTransfer:()=>Me,submitLedgerUnstake:()=>Ee,verifyAddress:()=>xe,waitLedgerTonApp:()=>Ie});var s=n(24450),a=n(68238),r=n(7416),o=n(1307),d=n(34557),i=n(3512),c=n(65871),l=n(66902),u=n(14568),f=n(23174),p=n(31481),w=n(76944),A=n(3476),m=n(94471),g=n(90746),y=n(3273),h=n(71902),v=n(99579),b=n(79145),S=n(28784),k=n(7941),T=n(8387),I=(n(67491),n(55029)),L=n(69780),E=n(96773),R=n(97935),M=n(61995),P=n(84752),C=n(86972),B=n(67132),D=n(48287).Buffer;n(809);var U=n(77744),W=n(48287).Buffer;const N=127;let O;function q(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mainnet";if(!O){const{apiHeaders:e,toncenterMainnetKey:t,toncenterTestnetKey:n}=undefined;O={mainnet:new U.x({endpoint:`${p._J8}/api/v2/jsonRPC`,timeout:p.cSq,apiKey:t,headers:e}),testnet:new U.x({endpoint:`${p.pyR}/api/v2/jsonRPC`,timeout:p.cSq,apiKey:n,headers:e})}}return O[e]}function _(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:A.e2,n=arguments.length>2?arguments[2]:void 0;return"string"==typeof e&&(e=o.Address.parse(e)),e.toString({urlSafe:!0,bounceable:t,testOnly:"testnet"===n})}function F(e,t){return(new o.Builder).storeUint(Number(e),1).storeUint(Number(t),1).asCell()}function x(e,t){const n=o.Dictionary.empty(o.Dictionary.Keys.Address(),o.Dictionary.Values.Bool());for(const t of e)n.set(o.Address.parse(t),!0);return(0,o.beginCell)().storeUint(M.Hx.CLAIM_REWARDS,32).storeUint(t??0,64).storeDict(n,o.Dictionary.Keys.Address(),o.Dictionary.Values.Bool()).endCell()}m.m,g.t,y.A,h.H,v.a,b.G,S.N,k.U,T.WalletContractV5R1,(0,L.A)((async(e,t,n)=>{const s=q(e).open(new R.Sr(o.Address.parse(n)));return _(await s.getWalletAddress(o.Address.parse(t)),!0,e)})),(0,L.A)((async(e,t)=>{const n=q(e).open(new B.K(o.Address.parse(t)));return _((await n.getWalletData()).minter,!0,e)})),(0,L.A)((async(e,t)=>{const n=await q(e).runMethodWithError(o.Address.parse(t),"get_public_key");var s;if(0===n.exit_code)return s=n.stack.readBigNumber().toString(16).padStart(64,"0"),Uint8Array.from(D.from(s,"hex"))})),(0,L.A)((async(e,t,n,s)=>{const a=q(e),r=a.open(C.Ml.createFromAddress(o.Address.parse(t))),d=await r.getWalletAddress(o.Address.parse(s),n);return a.open(P.sH.createFromAddress(d))}));var J=n(39989),K=n(86243);function V(e,t){const n=e.split(".").map(Number),s=t.split(".").map(Number);for(let e=0;e<Math.max(n.length,s.length);e++){const t=n[e]||0,a=s[e]||0;if(t>a)return 1;if(t<a)return-1}return 0}var j=n(37836),H=n(82393),G=n(99544),Y=n(85586),$=n(48287).Buffer,z=function(e){return e.v3R2="v3r2",e.v4R2="v4",e}(z||{});const Q=0,Z="v4R2",X=3,ee=10,te=125,ne=!1,se="2.1.0",ae="2.2.0",re=268,oe=d._t.map((e=>{let{masterAddress:t}=e;return t.toString({bounceable:!0,urlSafe:!0})}));let de,ie,ce,le,ue,fe,pe,we,Ae;async function me(){if(p.UMQ)return fe||(fe=Promise.all([n.e(580),n.e(513),n.e(642)]).then(n.bind(n,17642)).then((e=>e.BleConnector)),pe=await fe),fe}async function ge(){if(H.xy){if(!ue){ue=Promise.all([n.e(580),n.e(897)]).then(n.bind(n,52897)).then((e=>({transport:e.HIDTransport,listLedgerDevices:e.listLedgerDevices})));const e=await ue;we=e.transport,Ae=e.listLedgerDevices}return ue}}async function ye(){await me(),await ge();const[e,t,n]=await Promise.all([H.xy?we.isSupported():a.A.isSupported(),!!pe&&pe.isSupported(),r.A.isSupported()]);return ce={hid:e,bluetooth:t,webUsb:n},{isUsbAvailable:e||n,isBluetoothAvailable:t}}async function he(){const e=Ye();return e.hid?H.xy?await Ge(Ae):await Ge((()=>a.A.list()),(()=>a.A.create())):!!e.webUsb&&await Ge((()=>r.A.list()),(()=>r.A.create()))}async function ve(e,t){const n=await _e(e,t);return(0,w.p)("importLedgerWallet",e,n)}async function be(){try{var e;if(await(null===(e=ie)||void 0===e?void 0:e.isAppOpen()))return!0}catch{}if(!await Se())return!1;try{return await Ie()}catch(e){if((0,G.HN)(e.name))return be();throw e}}async function Se(e){const t=Ye();e&&(le=e);try{return"bluetooth"===le?de=await async function(){if(!pe)throw new Error("BLE is not supported on this device.");return(await pe.connect()).bleTransport}():t.hid?de=await(H.xy?async function(){for(let e=0;e<ee;e++){const[e]=await Ae();if(e)try{return await Promise.race([we.open(e),new Promise(((e,t)=>{setTimeout((()=>t(new Error)),1e3)}))])}catch(e){await(0,j.v7)(te)}else await(0,j.v7)(te)}throw new Error("Failed to connect")}():async function(){for(let e=0;e<ee;e++){const[e]=await a.A.list();if(e)return e.opened?new a.A(e):a.A.open(e);await a.A.create(),await(0,j.v7)(te)}throw new Error("Failed to connect")}()):t.webUsb&&(de=await async function(){for(let e=0;e<ee;e++){const[e]=await r.A.list();if(e)return e.opened?await r.A.openConnected()??await r.A.request():r.A.open(e);await r.A.create(),await(0,j.v7)(te)}throw new Error("Failed to connect")}()),de?(ie=new d.vs(de),!0):((0,I.SJ)("connectLedger: BLE and/or HID are not supported"),!1)}catch(e){return(0,I.SJ)("connectLedger",e),!1}}async function ke(){return await(0,j.v7)(te*ee),!1}async function Te(){for(let s=0;s<ee;s++){try{var e,t,n;if(await(null===(e=ie)||void 0===e?void 0:e.isAppOpen()))return null!==(t=de)&&void 0!==t&&null!==(t=t.deviceModel)&&void 0!==t&&t.id.startsWith("nanoS")&&await(null===(n=ie)||void 0===n?void 0:n.getAddress(Ke(0),{walletVersion:z[Z]})),!0}catch(e){if((0,G.HN)(e.name))throw ie=void 0,e;null!=e&&e.message.includes("0x530c")||(0,I.SJ)("waitLedgerTonApp",e)}await(0,j.v7)(te)}return!1}function Ie(){return Promise.race([Te(),ke()])}async function Le(e,t,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0n;const a=await(0,w.p)("fetchAddress",e,"ton");let r;const o={type:"stake",fee:s};switch(n.type){case"nominators":r=await Me({accountId:e,password:"",toAddress:n.pool,amount:t+A.sl.stakeNominators,comment:A.v8},p.Tu9.slug,o);break;case"liquid":{const n={type:"tonstakers-deposit",queryId:0n,appId:null};r=await Me({accountId:e,password:"",toAddress:p.qMf,amount:t+A.sl.stakeLiquid},p.Tu9.slug,o,n);break}case"jetton":{const{pool:s,period:a,tokenAddress:d,tokenSlug:i}=n;Object.assign(o,{inMsgHash:void 0,slug:i,toAddress:s}),r=await Me({accountId:e,password:"",toAddress:s,tokenAddress:d,amount:t,data:C.Ml.stakePayload(a),forwardAmount:A.sl.stakeJettonsForward},p.Tu9.slug,o);break}case"ethena":o.toAddress=p.BV6,o.slug=n.tokenSlug,r=await Me({accountId:e,password:"",toAddress:p.BV6,tokenAddress:p.wpN.tokenAddress,amount:t,forwardAmount:A.sl.stakeEthenaForward},p.Tu9.slug,o)}return r&&await(0,w.p)("updateAccountMemoryCache",e,a,{stakedAt:Date.now()}),r}async function Ee(e,t,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0n;const{network:a}=(0,K.cK)(e),r=await(0,w.p)("fetchAddress",e,"ton");let d;const c={type:"unstakeRequest",fee:s};switch(t.type){case"nominators":{const n=_(t.pool,!0,a);d=await Me({accountId:e,password:"",toAddress:n,amount:A.sl.unstakeNominators,comment:A.mv},p.Tu9.slug,c);break}case"liquid":{const s=await(0,w.p)("resolveTokenWalletAddress",a,r,p.Kzb),o=!1,l=(t.instantAvailable?f.Dn.Default:f.Dn.BestRate)===f.Dn.BestRate,u={type:"jetton-burn",queryId:0n,amount:n,responseDestination:i.Address.parse(r),customPayload:F(l,o)};d=await Me({accountId:e,password:"",toAddress:s,amount:A.sl.unstakeLiquid},p.Tu9.slug,c,u);break}case"jetton":{const{stakeWalletAddress:s}=t,a={type:"unsafe",message:(l=n,(0,o.beginCell)().storeUint(M.Hx.UNSTAKE_JETTONS,32).storeUint(0,64).storeCoins(l).storeBit(true).endCell())};d=await Me({accountId:e,password:"",toAddress:s,amount:A.sl.unstakeJettons},p.Tu9.slug,c,a);break}case"ethena":c.amount=A.sl.unstakeEthena,d=await Me({accountId:e,password:"",toAddress:p.VG8.tokenAddress,amount:n,tokenAddress:p.VG8.tokenAddress,forwardAmount:A.sl.unstakeEthenaForward},p.Tu9.slug,c)}var l;return d}async function Re(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0n;const s=await(0,w.p)("fetchAddress",e,"ton");let a;switch(t.type){case"jetton":{const s={type:"unsafe",message:x(t.poolWallets)},r={fee:n};a=await Me({accountId:e,amount:A.sl.claimJettons,password:"",toAddress:t.stakeWalletAddress},p.Tu9.slug,r,s);break}case"ethena":{const r={type:"unsafe",message:Y.G.transferTimelockedMessage({jettonAmount:t.lockedBalance,to:i.Address.parse(p.VG8.tokenAddress),responseAddress:i.Address.parse(s),forwardTonAmount:A.sl.unstakeEthenaLockedForward})},o={type:"unstake",fee:n};a=await Me({accountId:e,password:"",toAddress:t.tsUsdeWalletAddress,amount:A.sl.unstakeEthenaLocked},p.Tu9.slug,o,r)}}return a}async function Me(e,t,n,s){const{accountId:a,tokenAddress:r,comment:o,data:d,forwardAmount:c}=e;let{toAddress:l,amount:p}=e;const{network:m}=(0,K.cK)(a),g=await(0,w.p)("waitAndCreateTonPendingTransfer",a),y=await(0,w.p)("fetchAddress",a,"ton"),[h,v,b,S]=await Promise.all([Je(a),(0,w.p)("getWalletInfo",m,y),je(),(0,w.p)("fetchLedgerAccount",a)]),{seqno:k,balance:T}=v,L=i.Address.parseFriendly(l);let E=L.isBounceable;const R=L.address.toString({urlSafe:!0,bounceable:A.e2}),{isUnsafeSupported:M,isJettonIdSupported:P}=b;if(r)({toAddress:l,amount:p,payload:s}=await Ce({network:m,tokenAddress:r,fromAddress:y,toAddress:l,amount:p,data:o||d,isJettonIdSupported:P,forwardAmount:c})),E=!0;else if(o)if((0,G.Vq)(o))s={type:"comment",text:o};else{if(!M)return{error:f.jf.NotSupportedHardwareOperation};s={type:"unsafe",message:De(o)}}const C=(r||T!==p?u.SendMode.PAY_GAS_SEPARATELY:u.SendMode.CARRY_ALL_REMAINING_BALANCE)+u.SendMode.IGNORE_ERRORS,B="v3R2"===S.ton.version?{includeWalletOp:!1}:void 0;try{const r={base64:(await ie.signTransaction(h,{to:i.Address.parse(l),sendMode:C,seqno:k,timeout:Ve(),bounce:E,amount:BigInt(p),payload:s,walletSpecifiers:B})).toBoc().toString("base64"),seqno:k,localActivity:{amount:e.amount,fromAddress:y,toAddress:R,comment:o,slug:t,fee:0n,...n}};return await(0,w.p)("sendSignedTransferMessage",a,r,g)}catch(e){return await(0,w.p)("cancelPendingTransfer",g),He(e),void(0,I.SJ)("submitLedgerTransfer",e)}}async function Pe(e){const{accountId:t,nftAddress:n,comment:s,nft:a,realFee:r}=e;let{toAddress:o}=e;const{network:d}=(0,K.cK)(t),l=await(0,w.p)("waitAndCreateTonPendingTransfer",t),m=await(0,w.p)("fetchAddress",t,"ton"),[g,y,h,v]=await Promise.all([Je(t),(0,w.p)("getWalletInfo",d,m),je(),(0,w.p)("fetchLedgerAccount",t)]);if(!h.isUnsafeSupported)return{error:f.jf.NotSupportedHardwareOperation};const{seqno:b}=y,S=(null==a?void 0:a.collectionAddress)===p.KmP&&(o===p.pV9||p.WVU.includes(o));let k=null,T=A.Wb;S?(({forwardPayload:k,toAddress:o}=function(e,t){const n=i.Address.parse(e).hash.readUint8()>>4,s=p.WVU[n];return{forwardPayload:(new c.Builder).storeUint(1609328194,32).storeUint(t,64).endCell(),toAddress:s}}(n,a.index)),T=50000000n):s&&(k=De(s));const L="v3R2"===v.ton.version?{includeWalletOp:!1}:void 0;try{const c={base64:(await ie.signTransaction(g,{to:i.Address.parse(n),sendMode:u.SendMode.PAY_GAS_SEPARATELY+u.SendMode.IGNORE_ERRORS,seqno:b,timeout:Ve(),bounce:!0,amount:A.uS,payload:{type:"nft-transfer",queryId:0n,newOwner:i.Address.parse(o),responseDestination:i.Address.parse(m),customPayload:null,forwardAmount:T,forwardPayload:k},walletSpecifiers:L})).toBoc().toString("base64"),seqno:b,localActivity:{amount:0n,fromAddress:m,toAddress:e.toAddress,comment:s,fee:r??0n,slug:p.Tu9.slug,nft:a,normalizedAddress:_(n,!0,d)}};return await(0,w.p)("sendSignedTransferMessage",t,c,l)}catch(e){return await(0,w.p)("cancelPendingTransfer",l),void(0,I.SJ)("submitLedgerNftTransfer",e)}}async function Ce(e){let{network:t,tokenAddress:n,fromAddress:s,toAddress:a,amount:r,data:o,isJettonIdSupported:d,forwardAmount:c=A.tF}=e;const l=await(0,w.p)("resolveTokenWalletAddress",t,s,n);if(n!==await(0,w.p)("resolveTokenAddress",t,l))throw new Error("Invalid contract");const u="string"==typeof o?De(o):o??null,f={type:"jetton-transfer",queryId:0n,amount:r,destination:i.Address.parse(a),responseDestination:i.Address.parse(s),customPayload:null,forwardAmount:c,forwardPayload:u,knownJetton:d?Be(n):null},p=await(0,w.p)("getAmountForTokenTransfer",n,!1);if(!p)throw new Error("Couldn't get the TON amount for transfer");let m=p.amount;return c>A.tF&&(m+=c),{amount:m,toAddress:l,payload:f}}function Be(e){const t=oe.indexOf(e);return t>-1?{jettonId:t,workchain:A.Zm}:null}function De(e){const t=function(e){const t=W.from(e),n=new Uint8Array(t.length+4),s=W.alloc(4);return s.writeUInt32BE(A.$G.Comment),n.set(s,0),n.set(t,4),n}(e);return function(e){const t=N;let n;for(let s=Math.ceil(e.length/t)-1;s>=0;s--){const a=s*t,r=Math.min(t,e.length-a),d=W.from(e.buffer,e.byteOffset+a,r),i=(new o.Builder).storeBuffer(d);n&&i.storeRef(n),n=i.endCell()}return n??o.Cell.EMPTY}(t)}async function Ue(e,t,n){const{isTonConnect:s,vestingAddress:a}=n??{},{network:r}=(0,K.cK)(e),[c,f,m]=await Promise.all([Je(e),je(),(0,w.p)("fetchLedgerAccount",e)]),g=m.ton.address,{isUnsafeSupported:y,isJettonIdSupported:h}=f;if(s&&!y)throw new J.cp("Please update Ledger TON app.");const v=await(0,w.p)("getWalletSeqno",e,a);let b;"v3R2"===m.ton.version&&(b={includeWalletOp:!1}),a&&(b={subwalletId:re,includeWalletOp:!1});const S=await Promise.all(t.map((async(e,t)=>{var n;const{toAddress:s,amount:a,stateInit:c,rawPayload:f}=e,p=i.Address.isFriendly(s)?i.Address.parseFriendly(s).isBounceable:A.e2;let m;if(f&&(m=(0,d.vY)(l.Cell.fromBase64(f),{disallowModification:!0})),"jetton-transfer"===(null===(n=m)||void 0===n?void 0:n.type)){const e=await(0,w.p)("resolveTokenAddress",r,s);m.knownJetton=h?Be(e):null}const g=c?(0,o.loadStateInit)(l.Cell.fromBase64(c).asSlice()):void 0;return{to:i.Address.parse(s),sendMode:u.SendMode.PAY_GAS_SEPARATELY+u.SendMode.IGNORE_ERRORS,seqno:v+t,timeout:Ve(),bounce:p,amount:BigInt(a),payload:m,walletSpecifiers:b,stateInit:g}}))),k=[],T=ee+S.length;let L=0,E=0;for(;L<S.length&&E<T;){const e=S[L],n=t[L];try{var R;const t=(await ie.signTransaction(c,e)).toBoc().toString("base64");k.push({base64:t,seqno:e.seqno,localActivity:{amount:n.amount,fromAddress:g,toAddress:n.toAddress,comment:"comment"===(null===(R=n.payload)||void 0===R?void 0:R.type)?n.payload.comment:void 0,fee:0n,slug:p.Tu9.slug}}),L++}catch(e){He(e),(0,I.SJ)("signLedgerTransactions",e)}E++}return k}async function We(e,t){const n=await Je(e),{timestamp:s,domain:a,payload:r}=t;return(await ie.getAddressProof(n,{domain:a,timestamp:s,payload:$.from(r)})).signature.toString("base64")}function Ne(e,t,n){return Me({accountId:e,password:"",toAddress:t.address,amount:A.sl.changeDns},p.Tu9.slug,{type:"dnsRenew",fee:n,nft:t},{type:"unsafe",message:E.n.buildFillUpMessage()})}function Oe(e,t,n,s){return Me({accountId:e,password:"",toAddress:t.address,amount:A.sl.changeDns},p.Tu9.slug,{type:"dnsChangeAddress",fee:s,nft:t},{type:"unsafe",message:E.n.buildChangeDnsWalletMessage(n)})}async function qe(e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const n=[];let s=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1)+1;try{for(;;){const a=await _e(e,s);if(t.includes(a.address))s+=1;else{if(0n===a.balance)return n.length||n.push(a),n;n.push(a),s+=1}}}catch(e){return(0,J.QS)(e)}}async function _e(e,t){var n,s;const a="testnet"===e,{address:r,publicKey:o}=await Fe(t,a),d=await(0,w.p)("getWalletBalance","ton",e,r);return{index:t,address:r,publicKey:o.toString("hex"),balance:d,version:Z,driver:"HID",deviceId:null===(n=de.deviceModel)||void 0===n?void 0:n.id,deviceName:null===(s=de.deviceModel)||void 0===s?void 0:s.productName}}function Fe(e,t){const n=Ke(e);return ie.getAddress(n,{testOnly:t,chain:Q,bounceable:A.eL,walletVersion:z[Z]})}async function xe(e){const[t,n]=await Promise.all([(0,w.p)("fetchLedgerAccount",e),Je(e)]);var s;await ie.validateAddress(n,{bounceable:ne,walletVersion:(s=t.ton.version,z[s])})}async function Je(e){return Ke((await(0,w.p)("fetchLedgerAccount",e)).ton.index)}function Ke(e,t){return[44,607,t?1:0,(arguments.length>2&&void 0!==arguments[2]?arguments[2]:A.Zm)===A.li.MasterChain?255:0,e,0]}function Ve(){return Math.floor(Date.now()/1e3+A.kF)}async function je(){var e;const t=await ie.getVersion();return{version:t,isUnsafeSupported:V(t,se)>=0,isJettonIdSupported:V(t,ae)>=0&&"nanoS"!==(null===(e=de.deviceModel)||void 0===e?void 0:e.id)}}function He(e){if(null!=e&&e.message.includes("(0xbd00)"))throw new J.bS;if((null==e?void 0:e.statusCode)===s.StatusCodes.CONDITIONS_OF_USE_NOT_SATISFIED)throw new J.KB}async function Ge(e,t){try{for(let n=0;n<X;n++){const[n]=await e();if(n)return!0;t&&await t(),await(0,j.v7)(te)}}catch(e){(0,I.SJ)("tryDetectDevice",e)}return!1}function Ye(){if(!ce)throw new Error("detectAvailableTransports not called");return ce}me(),ge()}}]);
//# sourceMappingURL=355.2c726ad1bf56ac5011de.js.map